<h1>Search</h1>

<div id="map">
</div>

<script>
var q = "<%= @query %>";
var l = "<%= @location %>";
var query_path = "<%= results_path %>";

function loadMap() {
  var center = new google.maps.LatLng(39.109, -94.589);
  
  var options = {
    zoom: 4,
    center: center,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    panControl: true,
    mapTypeControl: false,
    streetViewControl: true
  };
  
  var map = new google.maps.Map($("div#map").get(0), options);
  loadResults(map);
}

function loadResults(map) {
  $.ajax({
    url : query_path,
    type : 'get',
    data : {'q' : q, 'l' : l},
    
    success : function(results, req, status) {
      var bounds = new google.maps.LatLngBounds();
      for (var i = 0; i < results.length; i++) {
        job = results[i].job;
        
        if (job.lat == null || job.long == null) {
          continue;
        }
        
        var marker = new google.maps.Marker({
          map: map,
          animation: google.maps.Animation.DROP,
          position: new google.maps.LatLng(job.lat, job.long),
          title: job.title + ' - ' + job.company 
        });
        
        createInfoWindow(job, marker, map);
        
        bounds.extend(marker.position);
      }
      map.fitBounds(bounds);
    }
  });
}

function createInfoWindow(job, marker, map) {
  var contentString = '<strong><a href="'+job.source+'">' + 
      job.title+'</a></strong><br />'+job.company+'<br />'+
      job.desc+'<br /><em>'+job.city+', '+job.state+'</em>'+' '+job.date;
  
  marker.infowindow = new google.maps.InfoWindow({
    content: contentString
  });
  
  google.maps.event.addListener(marker, 'click', function() {
    marker.infowindow.open(map, marker);
  });
}

</script>

<%= javascript_include_tag 'http://maps.google.com/maps/api/js?sensor=false&callback=loadMap' %>
